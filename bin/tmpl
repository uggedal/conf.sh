#!/bin/sh

_tmpl() {
  local src=$(dirname $0)/../templates/$1
  local dest=$2
  local handler=$3
  local tmp=$(mktemp)
  local diff code

  trap "rm $tmp" EXIT TERM INT

  tmpl.awk $src > $tmp
  diff=$(diff $dest $tmp)

  [ $? -eq 0 ] && exit 0

  progress start tmpl $dest

  cat $tmp > $dest
  code=$?

  progress finish $code

  [ $code -eq 0 ] || {
    progress result "$diff"
    exit $code
  }

  progress result "$diff"

  [ -z "$handler" ] || notify $handler tmpl changed $dest
}

_tmpl "$@"
