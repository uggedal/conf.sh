#!/bin/sh

argv=$#
self=$0
env=
user=${user:-root}
repo=$(basename $(dirname $(readlink -f $self)))
run=run.sh
dest=/tmp/$repo

die() {
  printf "$@"
  exit 64
}

parse() {
  [ $argv -eq 1 ] || die '%s: <env>\n' $self

  env=$(readlink -f $1)
  . $env

  [ -n "$host" ] || die 'no host in %s\n' $env
  [ -n "$roles" ] || die 'no roles in %s\n' $env
}

mkrun() {
  local role

  cat <<EOF > $run
#!/bin/sh

set -e

PATH=$dest/bin:"\$PATH"

$(grep '^_' < $env | sed 's/^/export /')
$rolescripts
EOF

  for role in $roles; do
    printf '%s/roles/%s.sh\n' $dest $role >> $run
  done

  chmod 700 $run
}

sync() {
  (
    cd ..
    tar cpf - $repo | ssh $user@$host "tar xpf - -C $(dirname $dest)"
  )
}

execrun() {
  ssh $user@$host $dest/$run
}

parse "$@" && mkrun && sync && execrun
rm -f $run
