#!/bin/sh

argv=$#
self=$0
env=
user=${user:-root}
repo=$(basename $(dirname $(readlink -f $self)))
run=run.sh
dest=/tmp/$repo

die() {
  printf "$@"
  exit 64
}

parse() {
  [ $argv -eq 1 ] || die '%s: <env>\n' $self

  env=$(readlink -f $1)
  . $env

  [ -n "$host" ] || die 'no host in %s\n' $env
  [ -n "$roles" ] || die 'no roles in %s\n' $env
}

mkrun() {
  local exported rolescripts

  exported=$(grep '^_' < $env | sed 's/^/export /')
  for role in $roles; do
    rolescripts="${rolescripts}
${dest}/roles/${role}.sh"
  done

  cat <<EOF > $run
#!/bin/sh

set -e

PATH=$dest/bin:"\$PATH"

$exported
$rolescripts
EOF
  chmod 700 $run
}

sync() {
  (
    cd ..
    tar cpf - $repo | ssh $user@$host "tar xpf - -C $(dirname $dest)"
  )
}

execrun() {
  ssh $user@$host $dest/$run
}

parse "$@" && mkrun && sync && execrun
rm -f $run
