#!/bin/sh

self=$0
env=
debug=
user=${user:-root}
repo=$(basename $(dirname $(readlink -f $self)))
run=run.sh
dest=/tmp/$repo

die() {
  printf "$@" >&2
  exit 64
}

parse() {
  [ $# -eq 1 -o $# -eq 2 ] || die '%s: <env> [--debug]\n' $self

  env=$(readlink -f $1)
  . $env

  [ -n "$host" ] || die 'no host in %s\n' $env
  [ -n "$roles" ] || die 'no roles in %s\n' $env

  [ $# -ne 2 -o "$2" != '--debug' ] || debug='set -x'
}

remote() {
  [ $host = localhost ] || printf 'ssh %s@%s' $user $host
}

mkrun() {
  local role

  cat <<EOF > $run
#!/bin/sh
$debug
$(grep '^_' < $env | sed 's/^/export /')
EOF

  cat bin/*.sh >> $run
  cat roles/*.sh >> $run
  cat handlers/*.sh >> $run

  printf '%s_role || exit 1\n' $roles >> $run
  chmod 700 $run
}

sync() {
  (
    cd ..
    tar cpf - $repo/$run $repo/templates \
      | $(remote) "tar xpf - -C $(dirname $dest)"
  )
}

execrun() {
  $(remote) $dest/$run
}

parse "$@" && mkrun && sync && execrun
rm -f $run
